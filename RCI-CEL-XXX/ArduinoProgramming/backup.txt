/*
 Basic MQTT example (with SSL!)
 This sketch demonstrates the basic capabilities of the library.
 It connects to an MQTT server then:
  - publishes "hello world" to the topic "outTopic"
  - subscribes to the topic "inTopic", printing out any messages
    it receives. NB - it assumes the received payloads are strings not binary
 It will reconnect to the server if the connection is lost using a blocking
 reconnect function. See the 'mqtt_reconnect_nonblocking' example for how to
 achieve the same result without blocking the main loop.

 You will need to populate "certificates.h" with your trust anchors
 (see https://github.com/OPEnSLab-OSU/SSLClient/blob/master/TrustAnchors.md)
 and my_cert/my_key with your certificate/private key pair
 (see https://github.com/OPEnSLab-OSU/SSLClient#mtls).
*/
#include <SSLClient.h>
#include "certificates.h" // This file must be regenerated
#include <ArduinoMqttClient.h>
#include <M5Core2.h>
#include <SPI.h>
#include <Ethernet.h>

byte mac[] = {0x8C, 0x1F, 0x64, 0x81, 0x30, 0x00};
const char broker[]    = "06e8c7b775f1454b8b94fcd788277596.s2.eu.hivemq.cloud";
int        port        = 8883;
const char willTopic[] = "arduino/will";
const char inTopic[]   = "arduino/in";
const char outTopic[]  = "arduino/out";

const long interval = 10000;
unsigned long previousMillis = 0;

int count = 0;

EthernetClient ethClient;
SSLClient ethClientSSL(ethClient, TAs, (size_t)TAs_NUM, A36);
MqttClient mqttClient(ethClientSSL);
//MqttClient mqttClient(ethClient);

void callback(char* topic, byte* payload, unsigned int length) {
  M5.Lcd.print("Message arrived [");
  M5.Lcd.print(topic);
  M5.Lcd.print("] ");
  for (int i=0;i<length;i++) {
    M5.Lcd.print((char)payload[i]);
  }
  M5.Lcd.print(" ");
}
void onMqttMessage(int messageSize) {
  // we received a message, print out the topic and contents
  M5.Lcd.print("Received a message with topic '");
  M5.Lcd.print(mqttClient.messageTopic());
  M5.Lcd.print("', duplicate = ");
  M5.Lcd.print(mqttClient.messageDup() ? "true" : "false");
  M5.Lcd.print(", QoS = ");
  M5.Lcd.print(mqttClient.messageQoS());
  M5.Lcd.print(", retained = ");
  M5.Lcd.print(mqttClient.messageRetain() ? "true" : "false");
  M5.Lcd.print("', length ");
  M5.Lcd.print(messageSize);
  M5.Lcd.print(" bytes:");

  // use the Stream interface to print the contents
  while (mqttClient.available()) {
    M5.Lcd.print((char)mqttClient.read());
  }
  M5.Lcd.print(" ");

  M5.Lcd.print(" ");
}

void reconnectMqtt()
{
  String willPayload = "oh no!";
  bool willRetain = true;
  int willQos = 1;

  mqttClient.beginWill(willTopic, willPayload.length(), willRetain, willQos);
  mqttClient.print(willPayload);
  mqttClient.endWill();
  
  mqttClient.setUsernamePassword("ADAMMQTT2","Tennis19");
  
  M5.Lcd.print("Attempting to connect to the MQTT broker: ");
  M5.Lcd.print(broker);

  if (!mqttClient.connect(broker, port)) {
    M5.Lcd.print("MQTT connection failed! Error code = ");
    M5.Lcd.print(mqttClient.connectError());

    while (1);
  }

  M5.Lcd.print("You're connected to the MQTT broker!");
  M5.Lcd.print(" ");

  // set the message receive callback
  mqttClient.onMessage(onMqttMessage);

  M5.Lcd.print("Subscribing to topic: ");
  M5.Lcd.print(inTopic);
  M5.Lcd.print();

  // subscribe to a topic
  // the second parameter sets the QoS of the subscription,
  // the the library supports subscribing at QoS 0, 1, or 2
  int subscribeQos = 1;

  mqttClient.subscribe(inTopic, subscribeQos);

  // topics can be unsubscribed using:
  // mqttClient.unsubscribe(inTopic);

  M5.Lcd.print("Waiting for messages on topic: ");
  M5.Lcd.print(inTopic);
  M5.Lcd.print(" ");
}

/* After M5Core2 is started or reset
the program in the setUp () function will be run, and this part will only be run once.
After M5Core2 is started or reset, the program in the setup() function will be executed, and this part will only be executed once. */
void setup(){
  delay(15000);
  M5.begin(); //Init M5Core2. Initialize M5Core2
                    /* Power chip connected to gpio21, gpio22, I2C device
                      Set battery charging voltage and current
                      If used battery, please call this function in your project */
  M5.Lcd.print("Hello World"); // Print text on the screen (string) Print text on the screen (string)

  Serial.begin(115200);
  while(!Serial);
  Ethernet.init(26);
  Ethernet.begin(mac);

  M5.Lcd.print(Ethernet.hardwareStatus());

  reconnectMqtt();
}

/* After the program in setup() runs, it runs the program in loop()
The loop() function is an infinite loop in which the program runs repeatedly
After the program in the setup() function is executed, the program in the loop() function will be executed
The loop() function is an endless loop, in which the program will continue to run repeatedly */
void loop() {
  /*if (!client.connected()) {
    reconnect();
  }
  client.loop();*/
  mqttClient.poll();

   unsigned long currentMillis = millis();

  if (currentMillis - previousMillis >= interval) {
    // save the last time a message was sent
    previousMillis = currentMillis;

    String payload;

    payload += "hello world!";
    payload += " ";
    payload += count;

    M5.Lcd.print("Sending message to topic: ");
    M5.Lcd.print(outTopic);
    M5.Lcd.print(payload);

    // send message, the Print interface can be used to set the message contents
    // in this case we know the size ahead of time, so the message payload can be streamed

    bool retained = false;
    int qos = 1;
    bool dup = false;

    mqttClient.beginMessage(outTopic, payload.length(), retained, qos, dup);
    mqttClient.print(payload);
    mqttClient.endMessage();

    M5.Lcd.print(" ");

    count++;
  }
}